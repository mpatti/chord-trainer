<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chord Theory Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Outfit:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    // THEME: 'modern' or 'arcade'
    window.THEME = 'modern';
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <script>
    // Supabase config - uses placeholders that get replaced by GitHub Actions
    // Fallback values work if env vars aren't available
    window.ENV = window.ENV || {
      NEXT_PUBLIC_SUPABASE_URL: 'https://skprrfogphnsrtsrgrjo.supabase.co',
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: 'sb_publishable_Qb7immayhksG6trimQUg2g_ang9eKfT'
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0a0a0f;
      --card: #1a1a24;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --success: #22c55e;
      --error: #ef4444;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
    }
    
    /* ARCADE THEME */
    .arcade {
      --bg: #0d0221;
      --card: #1a0a2e;
      --accent: #ff00ff;
      --accent-glow: rgba(255, 0, 255, 0.5);
      --success: #00ffff;
      --error: #ffff00;
      --text: #ffffff;
      --text-secondary: #ff00ff;
      --level1: #ff00ff;
      --level2: #00ffff;
      --level3: #ffff00;
      --level4: #ff0000;
      --level5: #00ff00;
    }
    
    .arcade body, .arcade button, .arcade input, .arcade div, .arcade span {
      font-family: 'Press Start 2P', monospace !important;
    }
    
    .arcade button {
      border: 4px solid var(--accent) !important;
      box-shadow: 0 0 10px var(--accent), 4px 4px 0 #000 !important;
    }
    
    .arcade h1, .arcade .chord-name, .arcade .start-title {
      color: var(--accent) !important;
      text-shadow: 4px 4px 0 var(--success), 0 0 20px var(--accent) !important;
    }
    
    .arcade .key.white-key { background: #222 !important; border: 3px solid var(--accent) !important; }
    .arcade .key.black-key { background: #000 !important; border: 3px solid var(--success) !important; }
    .arcade .key.active { background: var(--accent) !important; }
    
    .arcade .leaderboard-card, .arcade .feedback-card, .arcade .challenge-card, .arcade .start-screen {
      border: 4px solid var(--accent) !important;
      box-shadow: 0 0 20px var(--accent), 8px 8px 0 #000 !important;
    }
    
    .arcade .stat-value { color: var(--success) !important; }
    .arcade .streak { color: var(--error) !important; }
    
    /* Level colors for arcade */
    .arcade .level-1 { color: var(--level1) !important; border-color: var(--level1) !important; }
    .arcade .level-2 { color: var(--level2) !important; border-color: var(--level2) !important; }
    .arcade .level-3 { color: var(--level3) !important; border-color: var(--level3) !important; }
    .arcade .level-4 { color: var(--level4) !important; border-color: var(--level4) !important; }
    .arcade .level-5 { color: var(--level5) !important; border-color: var(--level5) !important; }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse at top, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    h1 { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats { display: flex; gap: 20px; align-items: center; }
    .stat { text-align: center; }
    .stat-value { font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 600; }
    .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    .streak { color: #f59e0b; }
    main { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px 0; }
    .challenge-card { background: var(--card); border-radius: 20px; padding: 30px; text-align: center; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); }
    .level-badge { display: inline-block; background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-bottom: 15px; }
    .chord-name { font-family: 'Outfit', sans-serif; font-size: 4rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 0 30px var(--accent-glow); }
    .chord-hint { color: var(--text-secondary); font-size: 0.9rem; }
    .correct-flash { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Outfit', sans-serif; font-size: 5rem; font-weight: 700; color: var(--success); text-shadow: 0 0 30px var(--success); animation: fadeUp 1s forwards; pointer-events: none; z-index: 50; }
    
    /* Celebration effects */
    .celebrate-border { animation: borderFlash 0.5s ease-out; }
    @keyframes borderFlash { 0% { box-shadow: 0 0 0 0 var(--success); } 50% { box-shadow: 0 0 40px 10px var(--success); } 100% { box-shadow: 0 0 0 0 var(--success); } }
    
    .chord-name.celebrate { animation: chordPop 0.5s ease-out; }
    @keyframes chordPop { 0% { transform: scale(1); } 30% { transform: scale(1.3); filter: brightness(1.5); } 100% { transform: scale(1); } }
    
    @keyframes streakBounce { 0%, 100% { transform: scale(1); } 25% { transform: scale(1.4); } 50% { transform: scale(1.1); } 75% { transform: scale(1.2); } }
    
    /* Confetti */
    .confetti { position: fixed; pointer-events: none; z-index: 100; top: 50%; left: 50%; width: 0; height: 0; }
    .confetti-piece { position: absolute; width: 12px; height: 12px; animation: confettiExplode 0.8s ease-out forwards; }
    @keyframes confettiExplode { 
      0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 1; } 
      100% { transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.5); opacity: 0; } 
    }
    
    @keyframes fadeUp { 0% { opacity: 0; transform: translate(-50%, -30%); } 20% { opacity: 1; transform: translate(-50%, -50%); } 80% { opacity: 1; } 100% { opacity: 0; transform: translate(-50%, -70%); } }
    
    .piano-wrapper { display: flex; justify-content: center; margin: 30px 0; overflow-x: auto; }
    .piano { position: relative; width: 714px; height: 180px; }
    
    .key { position: absolute; cursor: pointer; transition: all 0.1s; }
    .white-key { width: 48px; height: 180px; background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%); border: 1px solid #999; border-radius: 0 0 4px 4px; }
    .white-key:hover { background: linear-gradient(180deg, #f0f0f0 0%, #ddd 100%); }
    .white-key.active { background: linear-gradient(180deg, var(--accent) 0%, #4f46e5 100%); box-shadow: 0 0 15px var(--accent-glow); }
    .black-key { width: 30px; height: 110px; background: linear-gradient(180deg, #222 0%, #000 100%); border-radius: 0 0 3px 3px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .black-key:hover { background: linear-gradient(180deg, #333 0%, #111 100%); }
    .black-key.active { background: linear-gradient(180deg, var(--accent) 0%, #4f46e5 100%); box-shadow: 0 0 10px var(--accent-glow); }
    
    .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    button { font-family: 'DM Sans', sans-serif; font-weight: 600; padding: 12px 30px; border-radius: 10px; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    
    .feedback-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .feedback-card { background: var(--card); padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; }
    .feedback-icon { font-size: 4rem; margin-bottom: 15px; }
    .feedback-title { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
    .feedback-title.correct { color: var(--success); }
    .feedback-title.wrong { color: var(--error); }
    .feedback-explanation { color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
    .correct-notes { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .note-tag { background: rgba(99, 102, 241, 0.2); color: var(--accent); padding: 5px 12px; border-radius: 15px; font-weight: 600; }
    
    .progress-section { margin-top: 30px; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #a855f7); transition: width 0.5s; }
    .progress-text { text-align: center; color: var(--text-secondary); font-size: 0.85rem; margin-top: 10px; }
    
    .leaderboard-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
    .leaderboard-btn:hover { background: rgba(255,255,255,0.2); }
    
    .leaderboard-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 200; }
    .leaderboard-card { background: var(--card); padding: 30px; border-radius: 20px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .leaderboard-title { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
    .leaderboard-entry { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .leaderboard-entry:last-child { border-bottom: none; }
    .leaderboard-rank { font-weight: 600; color: var(--accent); width: 40px; }
    .leaderboard-name { flex: 1; }
    .leaderboard-score { font-weight: 600; }
    .leaderboard-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--text); font-size: 1rem; margin-bottom: 15px; }
    .leaderboard-input:focus { outline: none; border-color: var(--accent); }
    .save-score-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; }
    
    /* Start screen */
    .start-screen { text-align: center; padding: 40px 20px; }
    .start-title { font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 700; margin-bottom: 20px; background: linear-gradient(135deg, var(--accent), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .start-subtitle { color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem; }
    .start-input { width: 100%; max-width: 300px; padding: 15px 20px; border-radius: 12px; border: 2px solid rgba(99, 102, 241, 0.3); background: rgba(255,255,255,0.1); color: var(--text); font-size: 1.2rem; margin-bottom: 20px; transition: border-color 0.3s; }
    .start-input:focus { outline: none; border-color: var(--accent); }
    .start-btn { font-size: 1.2rem; padding: 15px 40px; }
    
    /* Level up celebration */
    .celebration-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200; }
    .celebration-card { background: var(--card); padding: 50px; border-radius: 24px; text-align: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 2px solid var(--accent); box-shadow: 0 0 40px var(--accent-glow); }
    .celebration-title { font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; background: linear-gradient(135deg, #f59e0b, #ef4444, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 2s infinite; }
    .celebration-level { font-size: 1.5rem; color: var(--text-secondary); margin-bottom: 20px; }
    .celebration-emojis { font-size: 3rem; margin-bottom: 20px; animation: bounce 0.6s infinite; }
    
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes shimmer { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Chord definitions by level - expanded with all root notes
    const CHORDS = {
      1: [  // Level 1: Triads - all 12 roots
        { name: 'C', notes: ['C', 'E', 'G'] }, { name: 'Cm', notes: ['C', 'Eb', 'G'] },
        { name: 'D', notes: ['D', 'F#', 'A'] }, { name: 'Dm', notes: ['D', 'F', 'A'] },
        { name: 'E', notes: ['E', 'G#', 'B'] }, { name: 'Em', notes: ['E', 'G', 'B'] },
        { name: 'F', notes: ['F', 'A', 'C'] }, { name: 'Fm', notes: ['F', 'Ab', 'C'] },
        { name: 'G', notes: ['G', 'B', 'D'] }, { name: 'Gm', notes: ['G', 'Bb', 'D'] },
        { name: 'A', notes: ['A', 'C#', 'E'] }, { name: 'Am', notes: ['A', 'C', 'E'] },
        { name: 'Bb', notes: ['Bb', 'D', 'F'] }, { name: 'Bbm', notes: ['Bb', 'Db', 'F'] },
        { name: 'Eb', notes: ['Eb', 'G', 'Bb'] }, { name: 'Ebm', notes: ['Eb', 'Gb', 'Bb'] },
        { name: 'Ab', notes: ['Ab', 'C', 'Eb'] }, { name: 'Abm', notes: ['Ab', 'Cb', 'Eb'] },
        { name: 'Db', notes: ['Db', 'F', 'Ab'] }, { name: 'Dbm', notes: ['Db', 'Fb', 'Ab'] },
        { name: 'Gb', notes: ['Gb', 'Bb', 'Db'] }, { name: 'Gbm', notes: ['Gb', 'Bbb', 'Db'] },
        { name: 'B', notes: ['B', 'D#', 'F#'] }, { name: 'Bm', notes: ['B', 'D', 'F#'] },
      ],
      2: [  // Level 2: 7th chords - all 12 roots
        { name: 'Cmaj7', notes: ['C', 'E', 'G', 'B'] }, { name: 'Cm7', notes: ['C', 'Eb', 'G', 'Bb'] }, { name: 'C7', notes: ['C', 'E', 'G', 'Bb'] },
        { name: 'Dmaj7', notes: ['D', 'F#', 'A', 'C#'] }, { name: 'Dm7', notes: ['D', 'F', 'A', 'C'] }, { name: 'D7', notes: ['D', 'F#', 'A', 'C'] },
        { name: 'Emaj7', notes: ['E', 'G#', 'B', 'D#'] }, { name: 'Em7', notes: ['E', 'G', 'B', 'D'] }, { name: 'E7', notes: ['E', 'G#', 'B', 'D'] },
        { name: 'Fmaj7', notes: ['F', 'A', 'C', 'E'] }, { name: 'Fm7', notes: ['F', 'Ab', 'C', 'Eb'] }, { name: 'F7', notes: ['F', 'A', 'C', 'Eb'] },
        { name: 'Gmaj7', notes: ['G', 'B', 'D', 'F#'] }, { name: 'Gm7', notes: ['G', 'Bb', 'D', 'F'] }, { name: 'G7', notes: ['G', 'B', 'D', 'F'] },
        { name: 'Amaj7', notes: ['A', 'C#', 'E', 'G#'] }, { name: 'Am7', notes: ['A', 'C', 'E', 'G'] }, { name: 'A7', notes: ['A', 'C#', 'E', 'G'] },
        { name: 'Bbmaj7', notes: ['Bb', 'D', 'F', 'A'] }, { name: 'Bbm7', notes: ['Bb', 'Db', 'F', 'Ab'] }, { name: 'Bb7', notes: ['Bb', 'D', 'F', 'Ab'] },
        { name: 'Ebmaj7', notes: ['Eb', 'G', 'Bb', 'D'] }, { name: 'Ebm7', notes: ['Eb', 'Gb', 'Bb', 'Db'] }, { name: 'Eb7', notes: ['Eb', 'G', 'Bb', 'Db'] },
        { name: 'Abmaj7', notes: ['Ab', 'C', 'Eb', 'G'] }, { name: 'Abm7', notes: ['Ab', 'Cb', 'Eb', 'Gb'] }, { name: 'Ab7', notes: ['Ab', 'C', 'Eb', 'Gb'] },
        { name: 'Dbmaj7', notes: ['Db', 'F', 'Ab', 'C'] }, { name: 'Dbm7', notes: ['Db', 'Fb', 'Ab', 'Cb'] }, { name: 'Db7', notes: ['Db', 'F', 'Ab', 'Cb'] },
        { name: 'Gbmaj7', notes: ['Gb', 'Bb', 'Db', 'F'] }, { name: 'Gbm7', notes: ['Gb', 'Bbb', 'Db', 'Fb'] }, { name: 'Gb7', notes: ['Gb', 'Bb', 'Db', 'Fb'] },
        { name: 'Bmaj7', notes: ['B', 'D#', 'F#', 'A#'] }, { name: 'Bm7', notes: ['B', 'D', 'F#', 'A'] }, { name: 'B7', notes: ['B', 'D#', 'F#', 'A'] },
      ],
      3: [  // Level 3: Altered + half dim - expanded
        { name: 'C9', notes: ['C', 'E', 'G', 'Bb', 'D'] }, { name: 'Cm9', notes: ['C', 'Eb', 'G', 'Bb', 'D'] },
        { name: 'C7b9', notes: ['C', 'E', 'G', 'Bb', 'Db'] }, { name: 'C7#9', notes: ['C', 'E', 'G', 'Bb', 'D#'] },
        { name: 'F7#11', notes: ['F', 'A', 'C', 'Eb', 'G', 'B'] }, { name: 'B7#11', notes: ['B', 'D#', 'F#', 'A', 'C#', 'E#'] },
        { name: 'Bm7b5', notes: ['B', 'D', 'F', 'A'] }, { name: 'Cm7b5', notes: ['C', 'Eb', 'Gb', 'Bb'] },
        { name: 'Dm7b5', notes: ['D', 'F', 'Ab', 'C'] }, { name: 'Em7b5', notes: ['E', 'G', 'Bb', 'D'] },
        { name: 'Fm7b5', notes: ['F', 'Ab', 'Cb', 'Eb'] }, { name: 'Gm7b5', notes: ['G', 'Bb', 'Db', 'F'] },
        { name: 'Am7b5', notes: ['A', 'C', 'Eb', 'G'] }, { name: 'Bbm7b5', notes: ['Bb', 'Db', 'Fb', 'Ab'] },
        { name: 'Ebm7b5', notes: ['Eb', 'Gb', 'Bbb', 'Db'] }, { name: 'Abm7b5', notes: ['Ab', 'Cb', 'E', 'Gb'] },
        { name: 'Dbm7b5', notes: ['Db', 'Fb', 'A', 'Cb'] }, { name: 'Gbm7b5', notes: ['Gb', 'Bb', 'D', 'Fb'] },
        { name: 'G7b13', notes: ['G', 'B', 'D', 'F', 'Bb', 'Db'] }, { name: 'D7b13', notes: ['D', 'F#', 'A', 'C', 'Gb', 'Bb'] },
      ],
      4: [  // Level 4: Extended (9th, 11th, 13th)
        { name: 'C9', notes: ['C', 'E', 'G', 'Bb', 'D'] }, { name: 'Cm9', notes: ['C', 'Eb', 'G', 'Bb', 'D'] },
        { name: 'C13', notes: ['C', 'E', 'G', 'Bb', 'D', 'A'] }, { name: 'Cm13', notes: ['C', 'Eb', 'G', 'Bb', 'D', 'A'] },
        { name: 'C11', notes: ['C', 'E', 'G', 'Bb', 'D', 'F'] }, { name: 'Cm11', notes: ['C', 'Eb', 'G', 'Bb', 'D', 'F'] },
        { name: 'D9', notes: ['D', 'F#', 'A', 'C', 'E'] }, { name: 'Dm9', notes: ['D', 'F', 'A', 'C', 'E'] },
        { name: 'D13', notes: ['D', 'F#', 'A', 'C', 'E', 'B'] }, { name: 'Dm13', notes: ['D', 'F', 'A', 'C', 'E', 'B'] },
        { name: 'E9', notes: ['E', 'G#', 'B', 'D', 'F#'] }, { name: 'Em9', notes: ['E', 'G', 'B', 'D', 'F#'] },
        { name: 'F9', notes: ['F', 'A', 'C', 'Eb', 'G'] }, { name: 'Fm9', notes: ['F', 'Ab', 'C', 'Eb', 'G'] },
        { name: 'F13', notes: ['F', 'A', 'C', 'Eb', 'G', 'D'] }, { name: 'Fm13', notes: ['F', 'Ab', 'C', 'Eb', 'G', 'D'] },
        { name: 'G9', notes: ['G', 'B', 'D', 'F', 'A'] }, { name: 'Gm9', notes: ['G', 'Bb', 'D', 'F', 'A'] },
        { name: 'G13', notes: ['G', 'B', 'D', 'F', 'A', 'E'] }, { name: 'Gm13', notes: ['G', 'Bb', 'D', 'F', 'A', 'E'] },
        { name: 'A9', notes: ['A', 'C#', 'E', 'G', 'B'] }, { name: 'Am9', notes: ['A', 'C', 'E', 'G', 'B'] },
        { name: 'Bb9', notes: ['Bb', 'D', 'F', 'Ab', 'C'] }, { name: 'Bbm9', notes: ['Bb', 'Db', 'F', 'Ab', 'C'] },
        { name: 'Eb9', notes: ['Eb', 'G', 'Bb', 'Db', 'F'] }, { name: 'Ebm9', notes: ['Eb', 'Gb', 'Bb', 'Db', 'F'] },
        { name: 'Ab9', notes: ['Ab', 'C', 'Eb', 'Gb', 'Bb'] }, { name: 'Abm9', notes: ['Ab', 'Cb', 'Eb', 'Gb', 'Bb'] },
      ],
      5: [  // Level 5: Scale degree chords - show roman numeral + key
        { name: 'ii in C', notes: ['D', 'F', 'A'] },
        { name: 'V7 in G', notes: ['D', 'F#', 'A', 'C'] },
        { name: 'iii in Bb', notes: ['D', 'F', 'A'] },
        { name: 'ii in Eb', notes: ['C', 'Eb', 'G', 'Bb'] },
        { name: 'IV in F', notes: ['Bb', 'D', 'F'] },
        { name: 'V7 in C', notes: ['G', 'B', 'D', 'F'] },
        { name: 'vi in A', notes: ['F', 'A', 'C'] },
        { name: 'I in D', notes: ['D', 'F#', 'A'] },
        { name: 'vii in C', notes: ['B', 'D', 'F'] },
        { name: 'iii in G', notes: ['B', 'D', 'F#'] },
        { name: 'IV in Bb', notes: ['Eb', 'G', 'Bb'] },
        { name: 'V7 in F', notes: ['C', 'E', 'G', 'Bb'] },
        { name: 'ii in Bb', notes: ['C', 'Eb', 'G'] },
        { name: 'V7 in Bb', notes: ['F', 'A', 'C', 'Eb'] },
        { name: 'I in G', notes: ['G', 'B', 'D'] },
        { name: 'vi in D', notes: ['B', 'D', 'F#'] },
        { name: 'IV in C', notes: ['F', 'A', 'C'] },
        { name: 'iii in C', notes: ['E', 'G', 'B'] },
        { name: 'vi in E', notes: ['C#', 'E', 'G#'] },
        { name: 'V7 in A', notes: ['E', 'G#', 'B', 'D'] },
      ]
    };
    
    // Note to MIDI mapping
    const noteToMidi = {
      'C3': 48, 'C#3': 49, 'D3': 50, 'D#3': 51, 'E3': 52, 'F3': 53, 'F#3': 54, 'G3': 55, 'G#3': 56, 'A3': 57, 'A#3': 58, 'B3': 59,
      'C4': 60, 'C#4': 61, 'D4': 62, 'D#4': 63, 'E4': 64, 'F4': 65, 'F#4': 66, 'G4': 67, 'G#4': 68, 'A4': 69, 'A#4': 70, 'B4': 71, 'C5': 72
    };
    
    // Map flat notes to sharp equivalents for MIDI lookup (including double flats/sharps)
    const flatToSharp = {
      // Single flats
      'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#',
      'Cb': 'B', 'Fb': 'E', 'E#': 'F', 'B#': 'C',
      // Double flats
      'Dbb': 'C', 'Ebb': 'D', 'Gbb': 'F', 'Abb': 'G', 'Bbb': 'A',
      'Cbb': 'Bb', 'Fbb': 'Eb',
      // Double sharps
      'Cx': 'D', 'Dx': 'E', 'Fx': 'G', 'Gx': 'A', 'Ax': 'B',
      'Bx': 'C#', 'Ex': 'F#',
    };
    
    // Alternative note names (for display)
    const noteAlternates = {
      'C': ['C'], 'Db': ['C#', 'Bx'], 'D': ['D'], 'Eb': ['D#', 'Cx'], 'E': ['E', 'Fb'], 'F': ['F', 'E#'],
      'Gb': ['F#', 'Ex'], 'G': ['G'], 'Ab': ['G#'], 'A': ['A'], 'Bb': ['A#', 'Cbb'], 'B': ['B', 'Cb'],
      'Cb': ['B'], 'C#': ['Db'], 'D#': ['Eb'], 'F#': ['Gb'], 'G#': ['Ab'], 'A#': ['Bb'],
    };
    
    // Convert note to piano key format (handles single and double flats/sharps)
    const normalizeNote = (note) => {
      if (flatToSharp[note]) return flatToSharp[note];
      return note;
    };
    
    // Check if a note matches any of its alternatives
    const noteMatches = (userNote, chordNote) => {
      const normalizedUser = normalizeNote(userNote);
      const normalizedChord = normalizeNote(chordNote);
      if (normalizedUser === normalizedChord) return true;
      // Check alternatives
      const userAlternates = noteAlternates[normalizedUser] || [normalizedUser];
      const chordAlternates = noteAlternates[normalizedChord] || [normalizedChord];
      return userAlternates.some(a => chordAlternates.includes(a));
    };
    
    // Supabase client - configure via window.env or update these values
    const supabaseUrl = window.ENV?.NEXT_PUBLIC_SUPABASE_URL || 'https://skprrfogphnsrtsrgrjo.supabase.co';
    const supabaseKey = window.ENV?.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY || 'sb_publishable_Qb7immayhksG6trimQUg2g_ang9eKfT';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Piano keys: white keys are at fixed positions, black keys between them
    // C3 starts at left:0, each white key is 48px wide
    const WHITE_KEYS = [
      { note: 'C3', left: 0 }, { note: 'D3', left: 48 }, { note: 'E3', left: 96 }, { note: 'F3', left: 144 },
      { note: 'G3', left: 192 }, { note: 'A3', left: 240 }, { note: 'B3', left: 288 },
      { note: 'C4', left: 336 }, { note: 'D4', left: 384 }, { note: 'E4', left: 432 }, { note: 'F4', left: 480 },
      { note: 'G4', left: 528 }, { note: 'A4', left: 576 }, { note: 'B4', left: 624 }, { note: 'C5', left: 672 }
    ];
    
    const BLACK_KEYS = [
      { note: 'C#3', left: 33 }, { note: 'D#3', left: 81 },   // Between C-D, D-E (no black after E)
      { note: 'F#3', left: 177 }, { note: 'G#3', left: 225 }, { note: 'A#3', left: 273 },  // After F, between G-A, A-B
      { note: 'C#4', left: 369 }, { note: 'D#4', left: 417 },  // Between C-D, D-E
      { note: 'F#4', left: 513 }, { note: 'G#4', left: 561 }, { note: 'A#4', left: 609 }   // After F, between G-A, A-B
    ];
    
    const ALL_KEYS = [...WHITE_KEYS, ...BLACK_KEYS];
    
    const LEVEL_NAMES = ['', 'Beginner', 'Intermediate', 'Advanced', 'Expert', 'Scale Degrees'];
    const LEVEL_COLORS = ['', '#ff00ff', '#00ffff', '#ffff00', '#ff0000', '#00ff00'];
    
    function getChord(level, lastChordName = '') {
      // Level 1 = Beginner (index 0), Level 2 = Intermediate (index 1), etc.
      const chordIndex = Math.min(level - 1, 4);
      const chords = CHORDS[chordIndex + 1];
      // Don't repeat the same chord
      const available = chords.filter(c => c.name !== lastChordName);
      return available[Math.floor(Math.random() * available.length)];
    }
    
    const LEVEL_DESCRIPTIONS = {
      1: 'Triads - Major & Minor',
      2: '7th Chords',
      3: 'Altered & Half-Dim',
      4: 'All Chord Types',
      5: 'Scale Degree Chords',
    };
    
    function App() {
      const [selectedDifficulty, setSelectedDifficulty] = useState(1);
      const [streak, setStreak] = useState(0);
      const [currentChord, setCurrentChord] = useState(null);
      const [lastChordName, setLastChordName] = useState('');
      const [selectedNotes, setSelectedNotes] = useState([]);
      const [showFeedback, setShowFeedback] = useState(false);
      const [showCorrectFlash, setShowCorrectFlash] = useState(false);
      const [celebrate, setCelebrate] = useState(false);
      const [confetti, setConfetti] = useState([]);
      const [synth, setSynth] = useState(null);
      const [showLeaderboard, setShowLeaderboard] = useState(true);
      const [leaderboardData, setLeaderboardData] = useState([]);
      const [playerName, setPlayerName] = useState('');
      const [scoreSaved, setScoreSaved] = useState(false);
      const [gameEnded, setGameEnded] = useState(false);
      const [gameStarted, setGameStarted] = useState(false);
      
      useEffect(() => {
        if (window.THEME === 'arcade') document.body.classList.add('arcade');
        
        const initAudio = async () => {
          try {
            await Tone.start();
            const piano = new Tone.Sampler({
              urls: {
                C4: "C4.mp3",
                "D#4": "Ds4.mp3", 
                "F#4": "Fs4.mp3",
                A4: "A4.mp3",
              },
              release: 1,
              baseUrl: "https://tonejs.github.io/audio/salamander/",
            }).toDestination();
            setSynth(piano);
          } catch (e) {
            console.log('Audio init failed:', e);
          }
        };
        
        // Try to init on first user interaction
        const handleInteraction = () => {
          if (!synth) initAudio();
        };
        document.addEventListener('click', handleInteraction, { once: true });
        
        initAudio();
      }, []);
      
      const playNote = (note) => {
        if (!synth) return;
        const noteName = note.replace(/\d/g, '');
        const octave = note.match(/\d/)?.[0] || '4';
        try {
          synth.triggerAttackRelease(noteName + octave, '8n');
        } catch (e) {
          // Fallback if sample not loaded
        }
      };
      
      const playChord = (notes) => {
        if (!synth) return;
        notes.forEach((n, i) => {
          const noteName = normalizeNote(n);
          try {
            synth.triggerAttackRelease(noteName + '4', '1n');
          } catch (e) {
            // Fallback
          }
        });
      };
      
      const toggleNote = (note) => {
        setSelectedNotes(prev => prev.includes(note) ? prev.filter(n => n !== note) : [...prev, note]);
      };
      
      const handleSubmit = () => {
        const correct = currentChord.notes;
        // Check each selected note against chord notes (handles enharmonics)
        const allCorrect = selectedNotes.every(sel => 
          correct.some(crd => noteMatches(sel.replace(/\d/g, ''), crd))
        );
        const isCorrectNow = allCorrect && selectedNotes.length === correct.length;
        
        if (isCorrectNow) {
          const newStreak = streak + 1;
          setStreak(newStreak);
          
          // Show correct flash
          setShowCorrectFlash(true);
          setCelebrate(true);
          // Spawn confetti
          const colors = ['#ff00ff', '#00ffff', '#ffff00', '#00ff00', '#ff0000'];
          const pieces = Array.from({length: 30}, (_, i) => {
            const angle = (Math.random() * 360) * (Math.PI / 180);
            const distance = 150 + Math.random() * 200;
            const tx = Math.cos(angle) * distance + 'px';
            const ty = Math.sin(angle) * distance + 'px';
            const rot = (Math.random() * 720 - 360) + 'deg';
            return {
              id: Date.now() + i,
              color: colors[Math.floor(Math.random() * colors.length)],
              tx, ty, rot,
              delay: Math.random() * 0.1
            };
          });
          setConfetti(pieces);
          setTimeout(() => setConfetti([]), 1000);
          setTimeout(() => setCelebrate(false), 500);
          setTimeout(() => setShowCorrectFlash(false), 800);
          
          playChord(currentChord.notes);
          // Auto-advance after 0.8 seconds
          setTimeout(() => {
            setSelectedNotes([]);
            setLastChordName(currentChord.name);
            setCurrentChord(getChord(selectedDifficulty, currentChord.name));
          }, 800);
        } else {
          // Wrong answer - game over!
          setShowFeedback(true);
          setGameEnded(true);
          return; // Stop here - don't advance
        }
      };
      
      const handleNext = () => {
        setShowFeedback(false);
        setSelectedNotes([]);
        setLastChordName(currentChord.name);
        setCurrentChord(getChord(selectedDifficulty, currentChord.name));
      };
      
      const startGame = () => {
        if (playerName.trim()) {
          localStorage.setItem('chordTrainerName', playerName);
          setCurrentChord(getChord(selectedDifficulty));
          setGameStarted(true);
          setShowLeaderboard(false);
        }
      };
      
      const currentLevel = selectedDifficulty;
      
      const handlePreview = () => currentChord && playChord(currentChord.notes);
      
      const fetchLeaderboard = async () => {
        const { data, error } = await supabase
          .from('leaderboard')
          .select('*')
          .order('score', { ascending: false })
          .limit(10);
        if (!error && data) setLeaderboardData(data);
      };
      
      const saveScore = async () => {
        if (!playerName.trim()) return;
        const { error } = await supabase
          .from('leaderboard')
          .insert([{ player_name: playerName, score: streak, level: selectedDifficulty }]);
        if (!error) {
          setScoreSaved(true);
          fetchLeaderboard();
          setShowFeedback(false);
          setGameStarted(false); // Return to menu (game over)
        }
      };
      
      const openLeaderboard = () => {
        fetchLeaderboard();
        setShowLeaderboard(true);
      };
      
      const endGame = () => {
        setGameEnded(true);
        setShowLeaderboard(true);
      };
      
      const restartGame = () => {
        setStreak(0);
        setSelectedNotes([]);
        setShowFeedback(false);
        setGameEnded(false);
        setScoreSaved(false);
        setShowLeaderboard(false);
        setGameStarted(false);
      };
      
      // Load saved name on mount
      useEffect(() => {
        const saved = localStorage.getItem('chordTrainerName');
        if (saved) setPlayerName(saved);
        fetchLeaderboard();
      }, []);
      
      if (!gameStarted) {
        return (
          <div className="container">
            <main className={celebrate ? 'celebrate' : ''}>
              <div className="start-screen">
                <div className="start-title">üéπ Chord Theory Trainer</div>
                <div className="start-subtitle">Choose your difficulty and get the highest streak!</div>
                
                <div className="leaderboard-section" style={{marginBottom: '20px', maxHeight: '200px', overflowY: 'auto', textAlign: 'left'}}>
                  <div style={{fontWeight: '600', marginBottom: '10px', textAlign: 'center'}}>üèÜ Top Scores</div>
                  {leaderboardData.length > 0 ? leaderboardData.slice(0,5).map((entry, i) => (
                    <div key={entry.id} style={{display: 'flex', justifyContent: 'space-between', padding: '8px 12px', borderBottom: '1px solid rgba(255,255,255,0.1)'}}>
                      <span style={{color: 'var(--accent)'}}>#{i+1}</span>
                      <span style={{flex: 1, paddingLeft: '10px'}}>{entry.player_name}</span>
                      <span style={{fontWeight: '600'}}>{entry.score} üî•</span>
                    </div>
                  )) : <p style={{textAlign: 'center', color: 'var(--text-secondary)'}}>No scores yet!</p>}
                </div>
                
                <input
                  type="text"
                  className="start-input"
                  placeholder="Enter your name"
                  value={playerName}
                  onChange={(e) => setPlayerName(e.target.value)}
                  maxLength={20}
                />
                <div style={{marginTop: '20px'}}>
                  <div style={{color: 'var(--text-secondary)', marginBottom: '10px'}}>Select Difficulty:</div>
                  <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                    <button className="btn-secondary" onClick={() => setSelectedDifficulty(1)} style={selectedDifficulty === 1 ? {borderColor: 'var(--accent)', borderWidth: '2px', borderStyle: 'solid', background: 'rgba(99,102,241,0.2)'} : {}}>Level 1: Triads (Beginner)</button>
                    <button className="btn-secondary" onClick={() => setSelectedDifficulty(2)} style={selectedDifficulty === 2 ? {borderColor: 'var(--accent)', borderWidth: '2px', borderStyle: 'solid', background: 'rgba(99,102,241,0.2)'} : {}}>Level 2: 7ths (Intermediate)</button>
                    <button className="btn-secondary" onClick={() => setSelectedDifficulty(3)} style={selectedDifficulty === 3 ? {borderColor: 'var(--accent)', borderWidth: '2px', borderStyle: 'solid', background: 'rgba(99,102,241,0.2)'} : {}}>Level 3: Altered + Half-Dim (Advanced)</button>
                    <button className="btn-secondary" onClick={() => setSelectedDifficulty(4)} style={selectedDifficulty === 4 ? {borderColor: 'var(--accent)', borderWidth: '2px', borderStyle: 'solid', background: 'rgba(99,102,241,0.2)'} : {}}>Level 4: All Types (Expert)</button>
                    <button className="btn-secondary" onClick={() => setSelectedDifficulty(5)} style={selectedDifficulty === 5 ? {borderColor: 'var(--accent)', borderWidth: '2px', borderStyle: 'solid', background: 'rgba(99,102,241,0.2)'} : {}}>Level 5: Scale Degrees</button>
                  </div>
                </div>
                <br />
                <button className="btn-primary start-btn" onClick={startGame} disabled={!playerName.trim()}>
                  Start Game üöÄ
                </button>
              </div>
            </main>
          </div>
        );
      }
      
      // Show leaderboard modal
      if (showLeaderboard) {
        return (
          <div className="leaderboard-modal">
            <div className="leaderboard-card">
              <button className="close-btn" onClick={() => setShowLeaderboard(false)}>√ó</button>
              <div className="leaderboard-title">üèÜ Leaderboard</div>
              
              {leaderboardData.length > 0 ? (
                leaderboardData.map((entry, i) => (
                  <div key={entry.id} className="leaderboard-entry">
                    <span className="leaderboard-rank">#{i + 1}</span>
                    <span className="leaderboard-name">{entry.player_name}</span>
                    <span className="leaderboard-score">{entry.score} üî• ({LEVEL_NAMES[entry.level]})</span>
                  </div>
                ))
              ) : (
                <p style={{textAlign: 'center', color: 'var(--text-secondary)'}}>No scores yet!</p>
              )}
            </div>
          </div>
        );
      }
      
      return (
        <div className="container">
          <header>
            <div>
              <h1>üéπ Chord Theory Trainer</h1>
              <div style={{fontSize: '0.85rem', color: 'var(--text-secondary)'}}>Playing as: {playerName}</div>
            </div>
            <div className="stats">
              <button className="leaderboard-btn" onClick={openLeaderboard}>üèÜ Leaderboard</button>
              <button className="leaderboard-btn" onClick={() => setGameStarted(false)}>‚ùå Quit</button>
              <div className="stat"><div className="stat-value streak" style={celebrate ? {animation: 'streakBounce 0.5s ease-out'} : {}}>{streak}</div><div className="stat-label">üî• Streak</div></div>
            </div>
          </header>
          
          <main>
            <div className="challenge-card" style={celebrate ? {animation: 'borderFlash 0.5s ease-out', borderColor: 'var(--success)'} : {}}>
              <div className="level-badge" style={window.THEME === 'arcade' ? {background: LEVEL_COLORS[selectedDifficulty], color: '#000', border: '3px solid ' + LEVEL_COLORS[selectedDifficulty]} : {}}>{LEVEL_NAMES[selectedDifficulty]} - {LEVEL_DESCRIPTIONS[selectedDifficulty]}</div>
              <div className="chord-name" style={{...window.THEME === 'arcade' ? {color: LEVEL_COLORS[selectedDifficulty]} : {}, ...(celebrate ? {animation: 'chordPop 0.5s ease-out'} : {})}}>{currentChord?.name}</div>
              <div className="chord-hint">Select all the notes in this chord</div>
            </div>
            
            <div className="piano-wrapper">
              <div className="piano">
                {WHITE_KEYS.map(k => (
                  <div key={k.note} className={`key white-key ${selectedNotes.includes(k.note) ? 'active' : ''}`}
                    style={{ left: k.left + 'px' }} onClick={() => toggleNote(k.note)} onMouseDown={() => playNote(k.note)} />
                ))}
                {BLACK_KEYS.map(k => (
                  <div key={k.note} className={`key black-key ${selectedNotes.includes(k.note) ? 'active' : ''}`}
                    style={{ left: k.left + 'px' }} onClick={() => toggleNote(k.note)} onMouseDown={() => playNote(k.note)} />
                ))}
              </div>
            </div>
            
            <div className="controls">
              <button className="btn-secondary" onClick={() => setSelectedNotes([])}>Clear</button>
              <button className="btn-primary" onClick={handleSubmit} disabled={selectedNotes.length === 0}>Submit</button>
            </div>
          </main>
          
          {showFeedback && (
            <div className="feedback-overlay">
              <div className="feedback-card">
                <div className="feedback-icon">‚ùå</div>
                <div className="feedback-title wrong">Sorry, that's not correct!</div>
                <div style={{marginBottom: '15px', color: 'var(--text-secondary)'}}>{currentChord?.name} = {currentChord?.notes.join(' - ')}</div>
                <div style={{fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '20px'}}>üî• Streak: {streak}</div>
                <div style={{marginBottom: '15px'}}>
                  <input
                    type="text"
                    className="leaderboard-input"
                    placeholder="Enter your name to save score"
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    maxLength={20}
                  />
                  <button className="btn-primary" style={{width: '100%'}} onClick={saveScore} disabled={!playerName.trim() || scoreSaved}>
                    {scoreSaved ? 'Saved!' : 'Save Score'}
                  </button>
                </div>
                <button className="btn-secondary" onClick={() => { setShowFeedback(false); setGameStarted(false); }}>
                  Back to Menu
                </button>
              </div>
            </div>
          )}
          
          {showCorrectFlash && <div className="correct-flash">‚úì</div>}
          {confetti.map(p => (
            <div key={p.id} className="confetti">
              <div className="confetti-piece" style={{background: p.color, animationDelay: p.delay + 's', '--tx': p.tx, '--ty': p.ty, '--rot': p.rot}} />
            </div>
          ))}
          
          {showLeaderboard && (
            <div className="leaderboard-modal">
              <div className="leaderboard-card">
                <button className="close-btn" onClick={() => setShowLeaderboard(false)}>√ó</button>
                <div className="leaderboard-title">üèÜ Leaderboard</div>
                
                {leaderboardData.length > 0 ? (
                  leaderboardData.map((entry, i) => (
                    <div key={entry.id} className="leaderboard-entry">
                      <span className="leaderboard-rank">#{i + 1}</span>
                      <span className="leaderboard-name">{entry.player_name}</span>
                      <span className="leaderboard-score">{entry.score} üî• ({LEVEL_NAMES[entry.level]})</span>
                    </div>
                  ))
                ) : (
                  <p style={{textAlign: 'center', color: 'var(--text-secondary)'}}>No scores yet!</p>
                )}
                
                {gameEnded && !scoreSaved && (
                  <div className="save-score-section">
                    <div style={{textAlign: 'center', marginBottom: '15px', fontSize: '1.2rem', fontWeight: '600'}}>
                      Streak: {streak} üî• ({LEVEL_NAMES[selectedDifficulty]})
                    </div>
                    <input
                      type="text"
                      className="leaderboard-input"
                      placeholder="Enter your name"
                      value={playerName}
                      onChange={(e) => setPlayerName(e.target.value)}
                      maxLength={20}
                    />
                    <button className="btn-primary" style={{width: '100%'}} onClick={saveScore}>
                      Save Score
                    </button>
                  </div>
                )}
                
                {scoreSaved && (
                  <div style={{textAlign: 'center', marginTop: '20px', color: 'var(--success)'}}>
                    ‚úì Score saved!
                  </div>
                )}
                
                {gameEnded && (
                  <>
                    <button className="btn-secondary" style={{width: '100%', marginTop: '15px'}} onClick={restartGame}>
                      Play Again
                    </button>
                    <button className="btn-primary" style={{width: '100%', marginTop: '10px'}} onClick={() => { setShowLeaderboard(false); setGameStarted(false); }}>
                      Choose Different Level
                    </button>
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
<!-- trigger deploy -->
