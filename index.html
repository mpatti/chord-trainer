<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chord Theory Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <script>
    // Configure Supabase from GitHub Actions env vars
    window.ENV = {
      NEXT_PUBLIC_SUPABASE_URL: 'NEXT_PUBLIC_SUPABASE_URL_PLACEHOLDER',
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY: 'NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY_PLACEHOLDER'
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0a0a0f;
      --card: #1a1a24;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --success: #22c55e;
      --error: #ef4444;
      --text: #f8fafc;
      --text-secondary: #94a3b8;
    }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse at top, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    h1 { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats { display: flex; gap: 20px; align-items: center; }
    .stat { text-align: center; }
    .stat-value { font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 600; }
    .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    .streak { color: #f59e0b; }
    main { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px 0; }
    .challenge-card { background: var(--card); border-radius: 20px; padding: 30px; text-align: center; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); }
    .level-badge { display: inline-block; background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-bottom: 15px; }
    .chord-name { font-family: 'Outfit', sans-serif; font-size: 4rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 0 30px var(--accent-glow); }
    .chord-hint { color: var(--text-secondary); font-size: 0.9rem; }
    
    .piano-wrapper { display: flex; justify-content: center; margin: 30px 0; overflow-x: auto; }
    .piano { position: relative; width: 714px; height: 180px; }
    
    .key { position: absolute; cursor: pointer; transition: all 0.1s; }
    .white-key { width: 48px; height: 180px; background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%); border: 1px solid #999; border-radius: 0 0 4px 4px; }
    .white-key:hover { background: linear-gradient(180deg, #f0f0f0 0%, #ddd 100%); }
    .white-key.active { background: linear-gradient(180deg, var(--accent) 0%, #4f46e5 100%); box-shadow: 0 0 15px var(--accent-glow); }
    .black-key { width: 30px; height: 110px; background: linear-gradient(180deg, #222 0%, #000 100%); border-radius: 0 0 3px 3px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .black-key:hover { background: linear-gradient(180deg, #333 0%, #111 100%); }
    .black-key.active { background: linear-gradient(180deg, var(--accent) 0%, #4f46e5 100%); box-shadow: 0 0 10px var(--accent-glow); }
    
    .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    button { font-family: 'DM Sans', sans-serif; font-weight: 600; padding: 12px 30px; border-radius: 10px; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    
    .feedback-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .feedback-card { background: var(--card); padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; }
    .feedback-icon { font-size: 4rem; margin-bottom: 15px; }
    .feedback-title { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
    .feedback-title.correct { color: var(--success); }
    .feedback-title.wrong { color: var(--error); }
    .feedback-explanation { color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
    .correct-notes { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .note-tag { background: rgba(99, 102, 241, 0.2); color: var(--accent); padding: 5px 12px; border-radius: 15px; font-weight: 600; }
    
    .progress-section { margin-top: 30px; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #a855f7); transition: width 0.5s; }
    .progress-text { text-align: center; color: var(--text-secondary); font-size: 0.85rem; margin-top: 10px; }
    
    .leaderboard-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
    .leaderboard-btn:hover { background: rgba(255,255,255,0.2); }
    
    .leaderboard-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 200; }
    .leaderboard-card { background: var(--card); padding: 30px; border-radius: 20px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .leaderboard-title { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
    .leaderboard-entry { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .leaderboard-entry:last-child { border-bottom: none; }
    .leaderboard-rank { font-weight: 600; color: var(--accent); width: 40px; }
    .leaderboard-name { flex: 1; }
    .leaderboard-score { font-weight: 600; }
    .leaderboard-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--text); font-size: 1rem; margin-bottom: 15px; }
    .leaderboard-input:focus { outline: none; border-color: var(--accent); }
    .save-score-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Chord definitions by level - simplified
    const CHORDS = {
      1: [  // All triads (major + minor)
        { name: 'C', notes: ['C', 'E', 'G'] },
        { name: 'Am', notes: ['A', 'C', 'E'] },
        { name: 'F', notes: ['F', 'A', 'C'] },
        { name: 'G', notes: ['G', 'B', 'D'] },
        { name: 'Dm', notes: ['D', 'F', 'A'] },
        { name: 'Em', notes: ['E', 'G', 'B'] },
        { name: 'D', notes: ['D', 'F#', 'A'] },
        { name: 'E', notes: ['E', 'G#', 'B'] },
        { name: 'Cm', notes: ['C', 'Eb', 'G'] },
        { name: 'Fm', notes: ['F', 'Ab', 'C'] },
        { name: 'Gm', notes: ['G', 'Bb', 'D'] },
        { name: 'Bm', notes: ['B', 'D', 'F#'] },
      ],
      2: [  // 7th chords (Maj7, Min7, Dom7)
        { name: 'Cmaj7', notes: ['C', 'E', 'G', 'B'] },
        { name: 'Fmaj7', notes: ['F', 'A', 'C', 'E'] },
        { name: 'Gmaj7', notes: ['G', 'B', 'D', 'F#'] },
        { name: 'Cm7', notes: ['C', 'Eb', 'G', 'Bb'] },
        { name: 'Fm7', notes: ['F', 'Ab', 'C', 'Eb'] },
        { name: 'Gm7', notes: ['G', 'Bb', 'D', 'F'] },
        { name: 'Bm7', notes: ['B', 'D', 'F#', 'A'] },
        { name: 'Dm7', notes: ['D', 'F', 'A', 'C'] },
        { name: 'C7', notes: ['C', 'E', 'G', 'Bb'] },
        { name: 'F7', notes: ['F', 'A', 'C', 'Eb'] },
        { name: 'G7', notes: ['G', 'B', 'D', 'F'] },
        { name: 'A7', notes: ['A', 'C#', 'E', 'G'] },
      ],
      3: [  // 9th chords + Altered dominants
        { name: 'C9', notes: ['C', 'E', 'G', 'Bb', 'D'] },
        { name: 'Dm9', notes: ['D', 'F', 'A', 'C', 'E'] },
        { name: 'Em9', notes: ['E', 'G', 'B', 'D', 'F#'] },
        { name: 'Fm9', notes: ['F', 'Ab', 'C', 'Eb', 'G'] },
        { name: 'Gm9', notes: ['G', 'Bb', 'D', 'F', 'A'] },
        { name: 'C7b9', notes: ['C', 'E', 'G', 'Bb', 'Db'] },
        { name: 'C7#9', notes: ['C', 'E', 'G', 'Bb', 'D#'] },
        { name: 'F7#11', notes: ['F', 'A', 'C', 'Eb', 'G', 'Bb', 'B'] },
        { name: 'G7b13', notes: ['G', 'B', 'D', 'F', 'Bb', 'Db'] },
      ],
      4: [  // Extended + Half diminished
        { name: 'C13', notes: ['C', 'E', 'G', 'Bb', 'D', 'A'] },
        { name: 'Dm13', notes: ['D', 'F', 'A', 'C', 'E', 'B'] },
        { name: 'C11', notes: ['C', 'E', 'G', 'Bb', 'D', 'F'] },
        { name: 'Dm11', notes: ['D', 'F', 'A', 'C', 'E', 'G'] },
        { name: 'Bm7b5', notes: ['B', 'D', 'F', 'A'] },
        { name: 'Cm7b5', notes: ['C', 'Eb', 'Gb', 'Bb'] },
        { name: 'Dm7b5', notes: ['D', 'F', 'Ab', 'C'] },
      ]
    };
    
    // Note to MIDI mapping
    const noteToMidi = {
      'C3': 48, 'C#3': 49, 'D3': 50, 'D#3': 51, 'E3': 52, 'F3': 53, 'F#3': 54, 'G3': 55, 'G#3': 56, 'A3': 57, 'A#3': 58, 'B3': 59,
      'C4': 60, 'C#4': 61, 'D4': 62, 'D#4': 63, 'E4': 64, 'F4': 65, 'F#4': 66, 'G4': 67, 'G#4': 68, 'A4': 69, 'A#4': 70, 'B4': 71, 'C5': 72
    };
    
    // Map flat notes to sharp equivalents for MIDI lookup
    const flatToSharp = {
      'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#',
      'Cb': 'B', 'Fb': 'E', 'E#': 'F', 'B#': 'C'
    };
    
    // Convert note to piano key format (flats to sharps)
    const normalizeNote = (note) => flatToSharp[note] || note;
    
    // Supabase client - configure via window.env or update these values
    const supabaseUrl = window.ENV?.NEXT_PUBLIC_SUPABASE_URL || 'https://skprrfogphnsrtsrgrjo.supabase.co';
    const supabaseKey = window.ENV?.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY || 'sb_publishable_Qb7immayhksG6trimQUg2g_ang9eKfT';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Piano keys: white keys are at fixed positions, black keys between them
    // C3 starts at left:0, each white key is 48px wide
    const WHITE_KEYS = [
      { note: 'C3', left: 0 }, { note: 'D3', left: 48 }, { note: 'E3', left: 96 }, { note: 'F3', left: 144 },
      { note: 'G3', left: 192 }, { note: 'A3', left: 240 }, { note: 'B3', left: 288 },
      { note: 'C4', left: 336 }, { note: 'D4', left: 384 }, { note: 'E4', left: 432 }, { note: 'F4', left: 480 },
      { note: 'G4', left: 528 }, { note: 'A4', left: 576 }, { note: 'B4', left: 624 }, { note: 'C5', left: 672 }
    ];
    
    const BLACK_KEYS = [
      { note: 'C#3', left: 33 }, { note: 'D#3', left: 81 },   // Between C-D, D-E (no black after E)
      { note: 'F#3', left: 177 }, { note: 'G#3', left: 225 }, { note: 'A#3', left: 273 },  // After F, between G-A, A-B
      { note: 'C#4', left: 369 }, { note: 'D#4', left: 417 },  // Between C-D, D-E
      { note: 'F#4', left: 513 }, { note: 'G#4', left: 561 }, { note: 'A#4', left: 609 }   // After F, between G-A, A-B
    ];
    
    const ALL_KEYS = [...WHITE_KEYS, ...BLACK_KEYS];
    
    function getChord(level) {
      const chords = CHORDS[Math.min(level, 4)] || CHORDS[1];
      return chords[Math.floor(Math.random() * chords.length)];
    }
    
    function App() {
      const [level, setLevel] = useState(1);
      const [xp, setXp] = useState(0);
      const [streak, setStreak] = useState(0);
      const [currentChord, setCurrentChord] = useState(getChord(1));
      const [selectedNotes, setSelectedNotes] = useState([]);
      const [showFeedback, setShowFeedback] = useState(false);
      const [isCorrect, setIsCorrect] = useState(false);
      const [questionsAnswered, setQuestionsAnswered] = useState(0);
      const [questionsCorrect, setQuestionsCorrect] = useState(0);
      const [synth, setSynth] = useState(null);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [leaderboardData, setLeaderboardData] = useState([]);
      const [playerName, setPlayerName] = useState('');
      const [scoreSaved, setScoreSaved] = useState(false);
      const [gameEnded, setGameEnded] = useState(false);
      
      useEffect(() => {
        Tone.start().then(() => {
          setSynth(new Tone.PolySynth(Tone.Synth).toDestination());
        });
      }, []);
      
      const playChord = (notes) => {
        if (!synth) return;
        const midi = notes.map(n => {
          // Handle flats: Ab -> G#, then look up with octave
          let noteName = n;
          if (flatToSharp[n]) noteName = flatToSharp[n];
          return noteToMidi[noteName + '4'] || 60;
        });
        synth.triggerAttackRelease(midi, '1n');
      };
      
      const toggleNote = (note) => {
        setSelectedNotes(prev => prev.includes(note) ? prev.filter(n => n !== note) : [...prev, note]);
      };
      
      const handleSubmit = () => {
        const correct = currentChord.notes;
        // Normalize all notes (flats to sharps) for comparison
        const correctNormalized = correct.map(normalizeNote);
        const selectedNormalized = selectedNotes.map(n => normalizeNote(n.replace(/\d/g, '')));
        const correctCount = correctNormalized.filter(n => selectedNormalized.includes(n)).length;
        const isCorrectNow = correctCount === correctNormalized.length && selectedNormalized.length === correctNormalized.length;
        
        setIsCorrect(isCorrectNow);
        setShowFeedback(true);
        
        if (isCorrectNow) {
          setStreak(s => s + 1);
          setXp(xp + 10 + streak * 2);
          setQuestionsCorrect(c => c + 1);
          playChord(currentChord.notes);
        } else {
          setStreak(0);
        }
        setQuestionsAnswered(q => q + 1);
      };
      
      const handleNext = () => {
        setShowFeedback(false);
        setSelectedNotes([]);
        
        if (questionsAnswered > 0 && questionsAnswered % 5 === 4) {
          if (questionsCorrect >= 3) setLevel(l => l + 1);
          setQuestionsCorrect(0);
        }
        
        setCurrentChord(getChord(level));
      };
      
      const handlePreview = () => currentChord && playChord(currentChord.notes);
      
      const fetchLeaderboard = async () => {
        const { data, error } = await supabase
          .from('leaderboard')
          .select('*')
          .order('score', { ascending: false })
          .limit(10);
        if (!error && data) setLeaderboardData(data);
      };
      
      const saveScore = async () => {
        if (!playerName.trim()) return;
        const { error } = await supabase
          .from('leaderboard')
          .insert([{ player_name: playerName, score: xp, level: level }]);
        if (!error) {
          setScoreSaved(true);
          fetchLeaderboard();
        }
      };
      
      const openLeaderboard = () => {
        fetchLeaderboard();
        setShowLeaderboard(true);
      };
      
      const endGame = () => {
        setGameEnded(true);
        setShowLeaderboard(true);
      };
      
      const restartGame = () => {
        setLevel(1);
        setXp(0);
        setStreak(0);
        setQuestionsAnswered(0);
        setQuestionsCorrect(0);
        setCurrentChord(getChord(1));
        setSelectedNotes([]);
        setShowFeedback(false);
        setGameEnded(false);
        setScoreSaved(false);
        setPlayerName('');
        setShowLeaderboard(false);
      };
      
      return (
        <div className="container">
          <header>
            <h1>üéπ Chord Theory Trainer</h1>
            <div className="stats">
              <button className="leaderboard-btn" onClick={openLeaderboard}>üèÜ Leaderboard</button>
              <div className="stat"><div className="stat-value">{xp}</div><div className="stat-label">XP</div></div>
              <div className="stat"><div className="stat-value streak">üî• {streak}</div><div className="stat-label">Streak</div></div>
            </div>
          </header>
          
          <main>
            <div className="challenge-card">
              <div className="level-badge">Level {level}</div>
              <div className="chord-name">{currentChord?.name}</div>
              <div className="chord-hint">Select all the notes in this chord</div>
            </div>
            
            <div className="piano-wrapper">
              <div className="piano">
                {WHITE_KEYS.map(k => (
                  <div key={k.note} className={`key white-key ${selectedNotes.includes(k.note) ? 'active' : ''}`}
                    style={{ left: k.left + 'px' }} onClick={() => toggleNote(k.note)} />
                ))}
                {BLACK_KEYS.map(k => (
                  <div key={k.note} className={`key black-key ${selectedNotes.includes(k.note) ? 'active' : ''}`}
                    style={{ left: k.left + 'px' }} onClick={() => toggleNote(k.note)} />
                ))}
              </div>
            </div>
            
            <div className="controls">
              <button className="btn-secondary" onClick={() => setSelectedNotes([])}>Clear</button>
              <button className="btn-secondary" onClick={handlePreview}>üîä Preview</button>
              <button className="btn-secondary" onClick={endGame}>üèÅ End Game</button>
              <button className="btn-primary" onClick={handleSubmit} disabled={selectedNotes.length === 0}>Submit</button>
            </div>
            
            <div className="progress-section">
              <div className="progress-bar">
                <div className="progress-fill" style={{ width: ((questionsAnswered % 5) / 5 * 100) + '%' }}></div>
              </div>
              <div className="progress-text">{questionsAnswered % 5}/5 to level up</div>
            </div>
          </main>
          
          {showFeedback && (
            <div className="feedback-overlay" onClick={handleNext}>
              <div className="feedback-card">
                <div className="feedback-icon">{isCorrect ? '‚úÖ' : '‚ùå'}</div>
                <div className={`feedback-title ${isCorrect ? 'correct' : 'wrong'}`}>
                  {isCorrect ? 'Correct!' : 'Not quite!'}
                </div>
                {!isCorrect && (
                  <>
                    <div className="correct-notes">
                      {currentChord?.notes.map(n => <span key={n} className="note-tag">{n}</span>)}
                    </div>
                    <div className="feedback-explanation">
                      {currentChord?.name} = {currentChord?.notes.join(' - ')}
                    </div>
                  </>
                )}
                <button className="btn-primary" onClick={handleNext}>Next</button>
              </div>
            </div>
          )}
          
          {showLeaderboard && (
            <div className="leaderboard-modal">
              <div className="leaderboard-card">
                <button className="close-btn" onClick={() => setShowLeaderboard(false)}>√ó</button>
                <div className="leaderboard-title">üèÜ Leaderboard</div>
                
                {leaderboardData.length > 0 ? (
                  leaderboardData.map((entry, i) => (
                    <div key={entry.id} className="leaderboard-entry">
                      <span className="leaderboard-rank">#{i + 1}</span>
                      <span className="leaderboard-name">{entry.player_name}</span>
                      <span className="leaderboard-score">{entry.score} XP</span>
                    </div>
                  ))
                ) : (
                  <p style={{textAlign: 'center', color: 'var(--text-secondary)'}}>No scores yet!</p>
                )}
                
                {gameEnded && !scoreSaved && (
                  <div className="save-score-section">
                    <div style={{textAlign: 'center', marginBottom: '15px', fontSize: '1.2rem', fontWeight: '600'}}>
                      Final Score: {xp} XP
                    </div>
                    <input
                      type="text"
                      className="leaderboard-input"
                      placeholder="Enter your name"
                      value={playerName}
                      onChange={(e) => setPlayerName(e.target.value)}
                      maxLength={20}
                    />
                    <button className="btn-primary" style={{width: '100%'}} onClick={saveScore}>
                      Save Score
                    </button>
                  </div>
                )}
                
                {scoreSaved && (
                  <div style={{textAlign: 'center', marginTop: '20px', color: 'var(--success)'}}>
                    ‚úì Score saved!
                  </div>
                )}
                
                {gameEnded && (
                  <button className="btn-secondary" style={{width: '100%', marginTop: '15px'}} onClick={restartGame}>
                    Play Again
                  </button>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
<!-- trigger deploy -->
